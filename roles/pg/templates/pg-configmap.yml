apiVersion: v1
kind: ConfigMap
metadata:
  name: pg-init
  namespace: "{{ansible_operator_meta.namespace}}"
data:
  init.sh: |
    #!/bin/bash

    _psql1 () { psql --set ON_ERROR_STOP=1 "$@" ; }
    _psql2 () { psql $POSTGRESQL_DATABASE $POSTGRESQL_USER --set ON_ERROR_STOP=1 "$@" ; }

    _psql1 <<< "ALTER USER $POSTGRESQL_USER WITH SUPERUSER;"

    _psql2 --set=username="$POSTGRESQL_USER" \
          --set=password="$POSTGRESQL_PASSWORD" \
    <<< "create extension pg_stat_statements ;"
    _psql2 --set=username="$POSTGRESQL_USER" \
        --set=password="$POSTGRESQL_PASSWORD" \
    <<< "alter system set shared_preload_libraries='pg_stat_statements';"