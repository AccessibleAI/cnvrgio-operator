apiVersion: v1
kind: ConfigMap
metadata:
  name: pg-init
  namespace: "{{ansible_operator_meta.namespace}}"
data:
  init.sh: |
    #!/bin/bash

    _psql1 () { psql --set ON_ERROR_STOP=1 "$@" ; }
    _psql2 () { psql $POSTGRESQL_DATABASE $POSTGRESQL_USER --set ON_ERROR_STOP=1 "$@" ; }

    _psql1 <<< "ALTER USER $POSTGRESQL_USER WITH SUPERUSER;"

    _psql2 --set=username="$POSTGRESQL_USER" \
          --set=password="$POSTGRESQL_PASSWORD" \
    <<< "create extension pg_stat_statements ;"
    _psql2 --set=username="$POSTGRESQL_USER" \
        --set=password="$POSTGRESQL_PASSWORD" \
    <<< "alter system set shared_preload_libraries='pg_stat_statements';"


#--set=connection="$POSTGRESQL_DATABASE \
# export PGPASSWORD=$POSTGRES_PASSWORD; psql  -d $POSTGRESQL_DATABASE  -c "create extension pg_stat_statements;"
# export PGPASSWORD=$POSTGRES_PASSWORD; psql  -d $POSTGRESQL_DATABASE  -c "alter system set shared_preload_libraries='pg_stat_statements';"

# export POSTGRESQL_DATABASE=cnvrg_production
# export POSTGRESQL_USER=cnvrg
# export POSTGRESQL_PASSWORD=cnvrg
# pg_ctl: another server might be running; trying to start server anyway
# waiting for server to start....2020-09-16 07:46:53.453 UTC [24] LOG:  starting PostgreSQL 12.1 on x86_64-redhat-linux-gnu, compiled by gcc (GCC) 4.8.5 20150623 (Red Hat 4.8.5-39), 64-bit
# 2020-09-16 07:46:53.456 UTC [24] LOG:  listening on Unix socket "/var/run/postgresql/.s.PGSQL.5432"
# 2020-09-16 07:46:53.459 UTC [24] LOG:  listening on Unix socket "/tmp/.s.PGSQL.5432"
# 2020-09-16 07:46:53.477 UTC [24] LOG:  redirecting log output to logging collector process
# 2020-09-16 07:46:53.477 UTC [24] HINT:  Future log output will appear in directory "log".
# .. done
# server started
# /var/run/postgresql:5432 - accepting connections
# => sourcing /usr/share/container-scripts/postgresql/start/set_passwords.sh ...
# ALTER ROLE
# ALTER ROLE
# waiting for server to shut down.... done
# server stopped
# Starting server...
# 2020-09-16 07:46:55.976 UTC [1] LOG:  starting PostgreSQL 12.1 on x86_64-redhat-linux-gnu, compiled by gcc (GCC) 4.8.5 20150623 (Red Hat 4.8.5-39), 64-bit
# 2020-09-16 07:46:55.976 UTC [1] LOG:  listening on IPv4 address "0.0.0.0", port 5432
# 2020-09-16 07:46:55.976 UTC [1] LOG:  listening on IPv6 address "::", port 5432
# 2020-09-16 07:46:55.979 UTC [1] LOG:  listening on Unix socket "/var/run/postgresql/.s.PGSQL.5432"
# 2020-09-16 07:46:55.982 UTC [1] LOG:  listening on Unix socket "/tmp/.s.PGSQL.5432"
# 2020-09-16 07:46:55.998 UTC [1] LOG:  redirecting log output to logging collector process
# 2020-09-16 07:46:55.998 UTC [1] HINT:  Future log output will appear in directory "log".