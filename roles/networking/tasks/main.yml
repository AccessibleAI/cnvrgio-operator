- name: Isito deployment
  vars:
    crds:
      - templates/istio/crds.yaml
    resources:
      - templates/istio/operator.yml
      - templates/istio/instance.yml
  block:
    # Includgin all variables - they are require for composing Istio VirtualService
    - include_vars: ../../../playbooks/vars/globals.yml
    - include_vars: ../../minio/vars/main.yml
    - include_vars: ../../pg/vars/main.yml
    - include_vars: ../../logging/vars/main.yml
    - include_vars: ../../redis/vars/main.yml
    - include_vars: ../../cnvrgApp/vars/main.yml


    - name: Set roleState if not set
      set_fact:
        roleState: "present"
      when: roleState is not defined
      tags: always

    # is state present, create crds in first step
    - name: Install Istio CRDs
      include_role:
        name: common
        tasks_from: install
      vars:
        templatePath: "{{ item }}"
        state: "present"
      loop: "{{crds}}"
      when: roleState == "present"

    # Install istio
    - name: Install Istio
      include_role:
        name: common
        tasks_from: install
      vars:
        templatePath: "{{ item }}"
        state: "present"
      loop: "{{resources}}"
      when: roleState == "present"

    - name: Get istiooperators.install.networking.istio.io
      k8s_info:
        api_version: install.networking.istio.io/v1alpha1
        kind: IstioOperator
        namespace: "{{ ansible_operator_meta.namespace }}"
        name: "cnvrg-istio"
      register: istioInstance
      when:
      - dryRun == "false"
      - roleState == "absent"

    - name: Print Istio instance
      debug:
        msg: "Current Istio instances: {{ istioInstance.resources }}"
      when:
      - dryRun == "false"
      - roleState == "absent"

    # Remove Istio
    - name: Remove Istio
      include_role:
        name: common
        tasks_from: install
      vars:
        templatePath: "{{ item }}"
        wait_to_complete: yes
        state: "present"
      loop: "{{resources|reverse|list}}"
      when:
      - roleState == "absent"
      - istioInstance.resources | length > 0

      # is state absent, remove crds in last step
    - name: Remove Istio CRDs
      include_role:
        name: common
        tasks_from: install
      vars:
        templatePath: "{{ item }}"
        state: "present"
      loop: "{{crds}}"
      when:
       - dryRun == "false"
       - roleState == "absent"
       - istioInstance.resources | length > 0
  when: networking.ingressType == "istio"

- name: Deploy OpenShift Route
  include_role:
    name: common
    tasks_from: install
  vars:
    templatePath: "{{ item }}"
    state: "present"
  with_fileglob:
    - templates/ocp-route/*
  when:
  - networking.ingressType == "openshift"

- name: Deploy VirtualServices
  include_role:
    name: common
    tasks_from: install
  vars:
    templatePath: "{{ item }}"
    state: "present"
  with_fileglob:
    - templates/istio-vs/*
  when: networking.ingressType == "istio"

- name: Deploy GW
  include_role:
    name: common
    tasks_from: install
  vars:
    templatePath: "{{ item }}"
    state: "present"
  with_fileglob:
    - templates/istio-gw/*
  when: networking.ingressType == "istio"

- name: Deploy K8S Ingress rules
  include_role:
    name: common
    tasks_from: install
  vars:
    templatePath: "{{ item }}"
    state: "present"
  with_fileglob:
    - templates/k8s-ingress/*
  when: networking.ingressType == "k8singress"
