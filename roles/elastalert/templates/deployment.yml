#jinja2: trim_blocks: "true", lstrip_blocks: "false"
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: "{{elastalert.svcName}}"
  name: "{{elastalert.svcName}}"
  namespace: "{{ ansible_operator_meta.namespace }}"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: "{{elastalert.svcName}}"
  template:
    metadata:
      labels:
        app: "{{elastalert.svcName}}"
    spec:
      {% if securityMode == "default" %}
      securityContext:
        runAsUser: {{ elastalert.runAsUser }}
        runAsGroup: {{ elastalert.runAsGroup }}
        fsGroup: {{ elastalert.fsGroup }}
      {% endif %}
      {% if tenancy.enabled == "true" and tenancy.dedicatedNodes == "true" %}
      tolerations:
      - key: "{{ tenancy.cnvrg.key }}"
        operator: "Equal"
        value: "{{ tenancy.cnvrg.value }}"
        effect: "NoSchedule"
      {% endif %}
      {% if hostpath.enabled == "true" and tenancy.enabled == "false" %}
      nodeSelector:
        kubernetes.io/hostname: "{{ hostpath.nodeName }}"
      {% elif hostpath.enabled == "false" and tenancy.enabled == "true" %}
      nodeSelector:
        {{ tenancy.cnvrg.key }}: "{{ tenancy.cnvrg.value }}"
      {% elif hostpath.enabled == "true" and tenancy.enabled == "true" %}
      nodeSelector:
        kubernetes.io/hostname: "{{ hostpath.nodeName }}"
        {{ tenancy.cnvrg.key }}: "{{ tenancy.cnvrg.value }}"
      {% endif %}
      containers:
      - image: "{{ elastalert.image }}"
        name: "{{elastalert.svcName}}"
        ports:
        - containerPort: {{elastalert.containerPort}}
          protocol: TCP
        resources:
          requests:
            cpu: "{{elastalert.cpuRequest}}"
            memory: "{{elastalert.memoryRequest}}"
          limits:
            cpu: "{{ elastalert.cpuLimit }}"
            memory: "{{ elastalert.memoryLimit }}"
        volumeMounts:
        - mountPath: /opt/elastalert-server/config/config.json
          subPath: config.json
          name: elastalert-config
        - mountPath: /opt/elastalert/config.yaml
          subPath: config.yaml
          name: elastalert-config
        - mountPath: /opt/elastalert/rules
          name: "{{elastalert.svcName}}"
      restartPolicy: Always
      serviceAccount: "{{rbac.serviceAccountName}}"
      serviceAccountName: "{{rbac.serviceAccountName}}"
      volumes:
      - name: "{{elastalert.svcName}}"
        persistentVolumeClaim:
          claimName: "{{elastalert.svcName}}"
      - configMap:
          name: elastalert-config
        name: elastalert-config