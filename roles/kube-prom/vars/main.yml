---
prometheus:
  enabled: "true"
  image: "quay.io/prometheus/prometheus:v2.17.2"
  operator_image: "quay.io/coreos/prometheus-operator:v0.38.1"
  config_reloader_image: "jimmidyson/configmap-reload:v0.3.0"
  prometheus_config_reloader_image: "quay.io/coreos/prometheus-config-reloader:v0.38.1"
  kube_rbac_proxy_image: "quay.io/coreos/kube-rbac-proxy:v0.4.1"
  kube_state_metrics_image: "quay.io/coreos/kube-state-metrics:v1.9.5"
  alert_manager_image: "quay.io/prometheus/alertmanager:v0.20.0"
  adapter_image: "directxman12/k8s-prometheus-adapter:v0.7.0"
  nvidia_exporter_image: "nvidia/dcgm-exporter:1.7.2"
  node_exporter_image: "quay.io/prometheus/node-exporter:v0.18.1"
  svc_name: "prometheus"
  port: 9090
  node_port: 30909
  storage_size: 40Gi
  storage_class: "use-default"
  kubelet_metrics:
    schema: https
    port: https-metrics

alertmanager:
  enabled: "true"
  alert_manager_image: "quay.io/prometheus/alertmanager:v0.21.0"
  svc_name: "alertmanager-main"
  port: 9093
  node_port: 39093
  storage_size: 20Gi
  storage_class: "use-default"
  config: |+
    global:
      resolve_timeout: 5m
    route:
      receiver: 'blackhole'
      group_by: ['alertname','job']
      repeat_interval: 24h
      group_interval: 5m
      routes:
      - receiver: 'slack-notifications'
        match:
          cnvrg: custom
        group_wait: 1m #1m
        group_interval: 2m #5m
        repeat_interval: 2m #12h
      - receiver: 'slack-watchdog'
        match:
          alertname: Watchdog
        group_wait: 1m
        group_interval: 1m
        repeat_interval: 1m
    receivers:
    - name: 'blackhole'
    - name: 'slack-watchdog'
      slack_configs:
      - api_url: "{{ 'aHR0cHM6Ly9ob29rcy5zbGFjay5jb20vc2VydmljZXMvVDA2M1hSRTJIL0IwMThNQjhQR1NLL0RoeVREMEt6ZnFsYlB3NTg2eXdCcmF2NA==' | b64decode }}"
        channel: '#slack-watchdog'
        send_resolved: true
        icon_url: https://avatars3.githubusercontent.com/u/3380462
        text: "not working"
    - name: 'slack-notifications'
      slack_configs:
      - api_url: "{{ 'aHR0cHM6Ly9ob29rcy5zbGFjay5jb20vc2VydmljZXMvVDA2M1hSRTJIL0IwMTkyM1A0NUVFL09iczVWRGlkU1lsVEJ0RzJHak9vWGoyWQ==' | b64decode }}"
        channel: '#alertmanager-alerts'
        send_resolved: true
        icon_url: https://avatars3.githubusercontent.com/u/3380462
        text: >+
          {{ '{{' }} range .Alerts {{ '}}' }}
          {{ '{{' }} if .Annotations.summary {{ '}}' }} *Summary:* `{{ '{{' }} .Annotations.summary {{ '}}' }}`{{ '{{' }} end {{ '}}' }}
          *Description:* {{ '{{' }} .Annotations.description {{ '}}' }}

          *Details:*
            {{ '{{' }} range .Labels.SortedPairs {{ '}}' }} â€¢ *{{ '{{' }} .Name {{ '}}' }}:* `{{ '{{' }} .Value {{ '}}' }}`
            {{ '{{' }} end {{ '}}' }}

          {{ '{{' }} end {{ '}}' }}
#title: "{{ '{{' }} range .Alerts {{ '}}' }}{{ '{{' }} .Annotations.summary {{ '}}' }}{{ '{{' }} end {{ '}}' }}"
#*Alert:* {{ '{{' }} .Annotations.title {{ '}}' }}{{ '{{' }} if .Labels.severity {{ '}}' }} - `{{ '{{' }} .Labels.severity {{ '}}' }}`{{ '{{' }} end {{ '}}' }}
#          {{ '{{' }} if .Annotations.summary {{ '}}' }} - Summary:`{{ '{{' }} .Annotations.summary {{ '}}' }}`{{ '{{' }} end {{ '}}' }}
#title: {{ '{{' }} .Alerts.alertname {{ '}}' }} doesnt work unmashal map into string

grafana:
  svc_name: "grafana"
  port: 3000
  image: grafana/grafana:6.7.4
  node_port: 30012
  datasources: |
    {
      "apiVersion": 1,
      "datasources": [
        {
          "access": "proxy",
          "editable": false,
          "name": "prometheus",
          "orgId": 1,
          "type": "prometheus",
          "url": "http://{{prometheus.svc_name}}.{{ansible_operator_meta.namespace}}.svc:9090",
          "version": 1
        }
      ]
    }