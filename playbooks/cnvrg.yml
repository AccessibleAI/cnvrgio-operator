- hosts: localhost
  gather_facts: no
  tasks:
    - name: "Include vars"
      include_vars: "{{ item }}"
      with_items:
        - vars/globals.yml
        - ../roles/conf/vars/main.yml
        - ../roles/redis/vars/main.yml
        - ../roles/pg/vars/main.yml
        - ../roles/pg_backup/vars/main.yml
        - ../roles/es/vars/main.yml
        - ../roles/minio/vars/main.yml
        - ../roles/monitoring/vars/main.yml
        - ../roles/istio/vars/main.yml
        - ../roles/kibana/vars/main.yml
        - ../roles/fluentd/vars/main.yml
        - ../roles/nvidiadp/vars/main.yml
        - ../roles/mpi/vars/main.yml
        - ../roles/cnvrgApp/vars/main.yml
        - ../roles/nfs/vars/main.yml
        - ../roles/hostpath/vars/main.yml
        - ../roles/ingress/vars/main.yml
        - ../roles/cnvrgRouter/vars/main.yml
        - ../roles/elastalert/vars/main.yml
        - ../roles/vpa/vars/main.yml
      tags: always

    - name: Set empty operatorRoles
      set_fact:
        operatorRoles: []

    - name: Add default operator roles list
      set_fact:
        defaultOperatorRoles: "{{ defaultOperatorRoles | default([]) + [role] }}"
      loop_control:
        loop_var: role
      loop:
        - { name: 'cnvrgApp', enabled: "{{cnvrgApp.enabled}}" }
        - { name: 'cnvrgRouter', enabled: "{{cnvrgRouter.enabled}}" }
        - { name: 'nfs', enabled: "{{nfs.enabled}}" }
        - { name: 'hostpath', enabled: "{{hostpath.enabled}}" }
        - { name: 'conf', enabled: "{{conf.enabled}}" }
        - { name: 'pg', enabled: "{{pg.enabled}}" }
        - { name: 'redis', enabled: "{{redis.enabled}}" }
        - { name: 'es', enabled: "{{es.enabled}}" }
        - { name: 'elastalert', enabled: "{{elastalert.enabled}}" }
        - { name: 'minio', enabled: "{{minio.enabled}}" }
        - { name: 'fluentd', enabled: "{{fluentd.enabled}}" }
        - { name: 'istio', enabled: "{{istio.enabled}}" }
        - { name: 'kibana', enabled: "{{kibana.enabled}}" }
        - { name: 'nvidiadp', enabled: "{{nvidiadp.enabled}}" }
        - { name: 'mpi', enabled: "{{mpi.enabled}}" }
        - { name: 'monitoring', enabled: "{{monitoring.enabled}}" }
        - { name: 'vpa', enabled: "{{vpa.enabled}}" }
        - { name: 'ingress', enabled: "{{ingress.enabled}}" }

    - name: Set operatorRoles if tags are `all` or not defined
      set_fact:
        operatorRoles: "{{ operatorRoles + [role] }}"
      loop_control:
        loop_var: role
      loop: "{{defaultOperatorRoles}}"
      when: (tags == "all") or (tags is not defined)

    - name: Set operatorRoles if tags are set for sepcifc roles
      set_fact:
        operatorRoles: "{{ operatorRoles + [role] }}"
      when:
      - tags != "all"
      - role.name in "{{tags.split(",")}}"
      loop_control:
        loop_var: role
      loop: "{{defaultOperatorRoles}}"

    - name: Deploy cnvrg stack
      include_role:
        name: "{{ role.name }}"
      when: role.enabled == "true"
      loop_control:
        loop_var: role
      loop: "{{operatorRoles}}"


