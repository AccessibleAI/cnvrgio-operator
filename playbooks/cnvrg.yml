- hosts: localhost
  gather_facts: no
  tasks:
    - name: "Include vars"
      include_vars: "{{ item }}"
      with_items:
        - vars/globals.yml
        - ../roles/conf/vars/main.yml
        - ../roles/redis/vars/main.yml
        - ../roles/pg/vars/main.yml
        - ../roles/pg_backup/vars/main.yml
        - ../roles/es/vars/main.yml
        - ../roles/minio/vars/main.yml
        - ../roles/kube-prom/vars/main.yml
        - ../roles/istio/vars/main.yml
        - ../roles/kibana/vars/main.yml
        - ../roles/fluentd/vars/main.yml
        - ../roles/nvidiadp/vars/main.yml
        - ../roles/mpi/vars/main.yml
        - ../roles/app/vars/main.yml
        - ../roles/nfs/vars/main.yml
        - ../roles/hostpath/vars/main.yml
        - ../roles/autoscaler/vars/main.yml
        - ../roles/ingress/vars/main.yml
        - ../roles/cnvrg_router/vars/main.yml
        - ../roles/status/vars/main.yml
      tags: always


    # Ingress rules deployment
    - import_role:
        name: ingress
      when: ingress.enabled == 'true'
      tags: ingress

    # Prometheus deployment
    - import_role:
        name: monitoring
      vars:
        role_state: "{{'present' if monitoring.enabled == 'true' else 'absent'}}"
      when: monitoring.enabled == "true"
      tags: monitoring
